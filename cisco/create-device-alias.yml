#!/bin/ansible-playbook
########################

# DESCRIPTION
# Creates and Removes Client Device Alias on Cisco MDS

# DIRECTIONS
# Usage to create a single device-alias
# Run ./create-device-alias.yml --tags create-adhoc -e "alias_name=ansible-host,wwpn=56:2:22:11:22:88:11:67" -v

# Usage to remove a single device-alias (note, wwpn value not required to remove)
# Run ./create-device-alias.yml --tags remove-adhoc -e "alias_name=ansible-host" -v

# Usage to create multiple device-alias using hosts.csv file: 
#     1. create a file called hosts.csv in the same directory as this playbook.
#     2. Make 4 columns titled "Hostname", "Platform", "WWPNA", and "WWPNB"
#     3. fill in the values in all columns for all the hosts you want to create.
#
# Run ./create-device-alias.yml --tags create-csv -v

# Usage to remove multiple device-alias using hosts.csv file:
# Run ./create-device-alias.yml --tags remove-csv -v

---
- name: "##### Create Client Device Alias on Cisco MDS #####"
  gather_facts: no
  hosts: '{{target|default("cisco-mds")}}'
  vars:
    creds:
      host: "{{ inventory_hostname }}"
      username: "{{ un }}"
      password: "{{ pwd }}"
      transport: cli
  tasks:

    - name: Reading the csv file
      read_csv:
        path: hosts.csv
      register: hosts_list
      delegate_to: localhost      
      tags:
      - create-csv
      - remove-csv    
      
    - name: Creates Cisco MDS device alias from hosts.csv
      nxos_devicealias:
          distribute: yes
          mode: enhanced
          da:
              - { name: '{{ item.Hostname }}_HB{{ fabricid }}', pwwn: '{{ item.WWPN{{ fabricid }} }}'}
             # - { name: '{{ item.Hostname }}_HB{{ fabricid }}', remove: True}
          provider: "{{ creds }}"          
      loop: "{{ hosts_list.list }}"
      register: result
      tags:
      - create-csv
    - debug: var=result

    - name: Removes Cisco MDS device alias from hosts.csv
      nxos_devicealias:
          distribute: yes
          mode: enhanced
          da:
             # - { name: '{{ item.Hostname }}_HB{{ fabricid }}', pwwn: '{{ item.WWPN{{ fabricid }} }}'}
              - { name: '{{ item.Hostname }}_HB{{ fabricid }}', remove: True}
          provider: "{{ creds }}"          
      loop: "{{ hosts_list.list }}"
      register: result
      tags:
      - remove-csv
    - debug: var=result

    - name: Creates Cisco MDS device alias
      nxos_devicealias:
          distribute: yes
          mode: enhanced
          da:
              - { name: '{{ alias_name }}', pwwn: '{{ wwpn }}'}
             # - { name: '{{ alias_name }}', remove: True}
          provider: "{{ creds }}"          
      loop: "{{ hosts_list.list }}"
      register: result
      tags:
      - create-adhoc
    - debug: var=result 

    - name: Removes Cisco MDS device alias
      nxos_devicealias:
          distribute: yes
          mode: enhanced
          da:
             # - { name: '{{ alias_name }}', pwwn: '{{ wwpn }}'}
              - { name: '{{ alias_name }}', remove: True}
          provider: "{{ creds }}"          
      loop: "{{ hosts_list.list }}"
      register: result
      tags:
      - remove-adhoc
    - debug: var=result  